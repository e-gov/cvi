<div
  class="cvi-multiselect"
  dataAttribute="test-multiselect"
  [class.filtered]="!!searchTerm"
  [class.has-value]="hasValue"
  [class.open]="isOpen"
  [class.is-input-hidden]="
    !isOpen && !searchInputFocused && (!hasValue || !backgroundDisabled)
  "
  [class.touched]="touched"
  [class.invalid]="invalid"
  [class.background-disabled]="backgroundDisabled"
  [class.disabled]="disabled"
  [class.search-has-focus]="searchInputFocused"
>
  <div class="cvi-multiselect__container" (mousedown)="handleMousedown($event)">
    <div class="cvi-multiselect__value-container">
      <ng-container>
        <div
          *ngFor="let item of selectedItems"
          class="cvi-multiselect__selected-item"
        >
          {{ item }}
        </div>
      </ng-container>
      <div
        *ngIf="!selectedItems.length && !searchTerm"
        class="cvi-multiselect__placeholder"
      >
        {{ placeholder }}
      </div>
    </div>
    <div class="cvi-multiselect__input-container">
      <input
        #searchInput
        type="text"
        role="combobox"
        autocomplete="off"
        aria-autocomplete="both"
        aria-haspopup="listbox"
        [attr.aria-activedescendant]="focusedItemHtmlId"
        [attr.aria-controls]="listboxHtmlId"
        [attr.aria-owns]="listboxHtmlId"
        [attr.id]="htmlId"
        dataAttribute="test-input"
        [attr.aria-expanded]="isOpen"
        [value]="inputValue"
        [disabled]="disabled"
        (keyup.arrowdown)="handleOpeningWithArrowFromKeyboard()"
        (focusin)="searchInputFocused = true"
        (focusout)="searchInputFocused = false"
        (input)="
          handleOpeningWithTypingFromKeyboard(); filter(searchInput.value)
        "
        class="cvi-multiselect__input"
      />
    </div>
    <button
      (click)="removeSelectedItems()"
      *ngIf="selectedItems.length"
      class="cvi-multiselect__close-button"
    >
      <cvi-ng-icon
        [height]="24"
        name="circle_close"
        class="cvi-multiselect__close-icon"
      ></cvi-ng-icon>
    </button>
    <span
      *ngIf="!selectedItems.length"
      [ngClass]="{ 'cvi-hidden': disabled || (backgroundDisabled && hasValue) }"
      class="cvi-multiselect__icon-wrapper"
      (mousedown)="handleArrowButtonClick($event)"
    >
      <ng-container *ngTemplateOutlet="icon"></ng-container>
    </span>
  </div>
  <div
    *ngIf="isOpen"
    dataAttribute="test-popup"
    class="cvi-dropdown-popup"
    (document:keydown.escape)="handleClosingFromKeyboard()"
    #popup
  >
    <div class="cvi-dropdown-popup__inner">
      <ul
        *ngIf="!loading; else dropdownPopupLoadingState"
        role="listbox"
        cviNgmultiselectNavigation
        (closed)="close()"
        [attr.aria-labelledby]="labelId"
        [attr.id]="listboxHtmlId"
      >
        <li
          role="option"
          class="cvi-multiselect__dropdown-item"
          [ngClass]="{ 'multiselect-is-current': isSelected(item.value) }"
          [attr.aria-selected]="isSelected(item.value)"
          dataAttribute="test-option"
          tabindex="0"
          [attr.id]="htmlId + '-listbox-item-' + idx"
          *ngFor="let item of itemsList.filteredItems; let idx = index"
          (click)="multiselectItem(item.value)"
        >
          <input
            [ngClass]="{
              'cvi-multiselect__item-checkbox': true,
              checked: isSelected(item.value)
            }"
            dataAttribute="test-option-checkbox"
            [attr.id]="htmlId"
            [attr.aria-labelledby]="'multiselectItemCheckbox-' + htmlId"
            role="checkbox"
            type="checkbox"
            [checked]="isSelected(item.value)"
          />
          <ng-template #defaultOptionTemplate>
            <span
              class="cvi-multiselect__item-label"
              for="'multiselectItemCheckbox-' + baseId"
            >
              {{ bindLabel ? item.value[bindLabel] : item.value }}
            </span>
          </ng-template>
          <ng-template
            [ngTemplateOutlet]="optionTemplate || defaultOptionTemplate"
            [ngTemplateOutletContext]="{ item: item.value }"
          >
          </ng-template>
        </li>
      </ul>
      <ng-template #dropdownPopupLoadingState>
        <div class="cvi-multiselect__dropdown-item">
          {{ loadingLabel }}
        </div>
      </ng-template>
    </div>
  </div>
</div>

<ng-template #icon>
  <cvi-ng-icon
    *ngIf="!isOpen && (!hasValue || !backgroundDisabled) && !loading"
    class="cvi-multiselect__icon-svg"
    aria-hidden="true"
    name="arrow_drop_down"
  >
  </cvi-ng-icon>
  <cvi-ng-icon
    *ngIf="!isOpen && hasValue && backgroundDisabled && !loading"
    class="cvi-multiselect__icon"
    aria-hidden="true"
    class="cvi-multiselect__icon-edit-svg"
    name="edit_simple"
  >
  </cvi-ng-icon>
  <cvi-ng-icon
    *ngIf="isOpen && !loading"
    class="cvi-multiselect__icon-svg"
    aria-hidden="true"
    name="arrow_drop_up"
  >
  </cvi-ng-icon>
  <div *ngIf="loading" class="cvi-multiselect__loading-spinner"></div>
</ng-template>
